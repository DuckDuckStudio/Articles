name: ç”Ÿæˆ Sitemap

on:
  push:
    branches:
      - main
    paths:
      - '**/*.html'
      - '**/*.md'
      - '.github/workflows/generate-sitemap.yml'
      - '.action_scripts/JavaScript/generate-sitemap.mjs'
  workflow_dispatch:

jobs:
  generate_sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: è®¾ç½®æ—¶åŒº
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: åˆ›å»º Sitemap
        run: node .action_scripts/JavaScript/generate-sitemap.mjs

      - name: æäº¤å¹¶æ¨é€ sitemap.xml
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
          DATE_TIME=$(date '+%Y/%m/%d %H:%M')
          
          BRANCH_NAME="sitemap-update-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "å·²åˆ›å»ºåˆ†æ”¯ $BRANCH_NAME"
          git config --global user.name "${{ secrets.BOT_ACCOUNT }}"
          git config --global user.email "${{ secrets.BOT_EMAIL }}"
          git add docs/sitemap.xml
          git commit -m "[${DATE_TIME}] Auto update sitemap"
          git push --set-upstream origin $BRANCH_NAME

          # ç”Ÿæˆå·¥ä½œæµ URL
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # ä½¿ç”¨ GitHub CLI åˆ›å»º PRï¼ŒåŠ¨æ€è®¾ç½® body å†…å®¹ä¸ºå·¥ä½œæµé“¾æ¥
          gh pr create --title "[${DATE_TIME}] Auto update sitemap" \
                       --body "Created through the [workflow](${WORKFLOW_URL})." \
                       --base main \
                       --head $BRANCH_NAME \
                       --label "å·¥ä½œæµ,DEV-å¼€å‘åˆ†æ”¯åˆå¹¶" \
                       --reviewer DuckDuckStudio

          echo "Pull Request åˆ›å»ºæˆåŠŸã€‚"

      - name: å¯ç”¨è‡ªåŠ¨åˆå¹¶ (å‹ç¼©)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # è·å–å‰é¢åˆ›å»ºçš„ PR ç¼–å·ï¼Œç¡®ä¿ PR ååŒ…å« "Auto update sitemap" å¹¶å¸¦æœ‰ "å·¥ä½œæµ" æ ‡ç­¾
          PR_NUMBER=$(gh pr list --limit 1 --search "Auto update sitemap" --label "å·¥ä½œæµ" --json number | jq -r '.[0].number')
          gh pr merge $PR_NUMBER --squash --auto
          gh pr comment $PR_NUMBER --body "è¿™çœ‹èµ·æ¥æ˜¯æ›´æ–°ç½‘ç«™åœ°å›¾çš„ PRï¼Œå·²è‡ªåŠ¨å¯ç”¨è‡ªåŠ¨åˆå¹¶ã€‚ğŸ‘"
